<?xml version="1.0"?>
<!--

  Copyright (c) 2011, PAL Robotics, S.L.
  All rights reserved.

  This work is licensed under the Creative Commons Attribution-NonCommercial-NoDerivs 3.0 Unported License.
  To view a copy of this license, visit http://creativecommons.org/licenses/by-nc-nd/3.0/ or send a letter to
  Creative Commons, 444 Castro Street, Suite 900, Mountain View, California, 94041, USA.
-->
<robot  xmlns:xacro="http://ros.org/wiki/xacro"
        xmlns:sensor="http://playerstage.sourceforge.net/gazebo/xmlschema/#sensor"
        xmlns:controller="http://playerstage.sourceforge.net/gazebo/xmlschema/#controller"
        xmlns:interface="http://playerstage.sourceforge.net/gazebo/xmlschema/#interface">

  <include filename="$(find reem_description)/urdf/deg_to_rad.xacro" />
  <include filename="$(find reem_description)/urdf/base/base.gazebo.xacro" />
  <include filename="$(find reem_description)/urdf/base/base.transmission.xacro" />
  <include filename="$(find reem_description)/urdf/sensors/sick_laser_reem.urdf.xacro" />
  <include filename="$(find reem_description)/urdf/sensors/hokuyo_laser_reem.urdf.xacro" />
  <!--<include filename="$(find reem_description)/urdf/sensors/microinfinity_xa3300.urdf.xacro" /> -->
  <include filename="$(find reem_description)/urdf/sensors/microstrain_3dmgx2_imu.urdf.xacro" />
  <include filename="$(find reem_description)/urdf/sensors/range.urdf.xacro" />

  <!--wheel characteristics-->
  <property name="dist_between_wheels" value="0.489" />
  <property name="wheel_radius" value="0.1075" />
  <property name="wheel_width" value="0.082" />

 <!--caster characteristics-->
  <property name="dist_between_casters" value="0.350" />
  <property name="caster_radius"        value="0.050" />
  <property name="caster_width"         value="0.032" />
  <property name="caster_trailing_dist" value="0.033" />

  <xacro:macro name="reem_wheel" params="side reflect" parent="base_link">

    <!--************************-->
    <!--        WHEELS          -->
    <!--************************-->
    <link name="wheel_${side}_link">
      <inertial>
        <origin xyz="0 0 0" rpy="0 0 0" />
        <mass value="1.0" />
        <inertia ixx="1"  ixy="0"  ixz="0" iyy="1" iyz="0" izz="1" />
      </inertial>
      <visual>
        <origin xyz="0 0 0" rpy="0 0 0" />
        <geometry>
          <cylinder radius="${wheel_radius}" length="${wheel_width}" />
        </geometry>
        <material name="DarkGrey" />
      </visual>
      <collision>
        <origin xyz="0 0 0" rpy="0 0 0" />
        <geometry>
          <cylinder radius="${wheel_radius}" length="${wheel_width}" />
        </geometry>
      </collision>
    </link>

    <joint name="wheel_${side}_joint" type="continuous">
      <parent link="base_link" />
      <child link="wheel_${side}_link" />
      <origin xyz="0 ${-dist_between_wheels / 2 * reflect} ${wheel_radius}" rpy="${-90.0 * deg_to_rad} 0 0" />
      <axis xyz="0 0 1" />
    </joint>

    <!-- extensions -->
    <xacro:reem_wheel_gazebo side="${side}" />
    <xacro:reem_wheel_transmission side="${side}" />

  </xacro:macro>

  <xacro:macro name="reem_caster" params="side reflect">
    <!--************************-->
    <!--        CASTERS         -->
    <!--************************-->

    <link name="caster_${side}_1_link">
      <inertial>
        <origin xyz="0 0 0" rpy="0 0 0"/>
        <mass value="0.1" />
        <inertia  ixx="0.012411765597" ixy="-0.000711733678" ixz="0.00050272983"
                  iyy="0.015218160428" iyz="-0.000004273467"
                  izz="0.011763977943" />
      </inertial>
      <visual>
        <origin xyz="0 0 0" rpy="0 0 0" />
        <geometry>
          <cylinder radius="${caster_radius}" length="${caster_width}"/>
        </geometry>
        <material name="DarkGrey" />
      </visual>
      <collision>
        <origin xyz="0 0 0" rpy="0 0 0" />
        <geometry>
          <cylinder radius="${caster_radius}" length="${caster_width}"/>
        </geometry>
      </collision>
    </link>

    <link name="caster_${side}_2_link">
      <inertial>
        <origin xyz="0 0 0" rpy="0 0 0"/>
        <mass value="0.1" />
        <inertia  ixx="0.012411765597" ixy="-0.000711733678" ixz="0.00050272983"
                  iyy="0.015218160428" iyz="-0.000004273467"
                  izz="0.011763977943" />
        </inertial>
      <visual>
        <origin xyz="0 0 0" rpy="0 0 0" />
        <geometry>
          <cylinder radius="${caster_radius}" length="${caster_width}"/>
        </geometry>
        <material name="DarkGrey" />
      </visual>
      <collision>
        <origin xyz="0 0 0" rpy="0 0 0" />
        <geometry>
          <cylinder radius="${caster_radius}" length="${caster_width}"/>
        </geometry>
      </collision>
    </link>

    <joint name="caster_${side}_1_joint" type="continuous">
      <parent link="base_link" />
      <child link="caster_${side}_1_link" />
      <origin xyz="-0.3805 ${-dist_between_casters / 2 * reflect} ${caster_radius}" rpy="0 0 0" />
      <axis xyz="0 0 1" />
    </joint>

    <joint name="caster_${side}_2_joint" type="continuous">
      <parent link="caster_${side}_1_link" />
      <child link="caster_${side}_2_link" />
      <origin xyz="${-caster_trailing_dist} 0 0" rpy="${-90.0 * deg_to_rad} 0 0" />
      <axis xyz="0 0 1" />
    </joint>

    <!-- extensions -->
    <xacro:reem_caster_gazebo side="${side}"/>
    <xacro:reem_caster_simple_transmission name="caster" side="${side}" number="1" reduction="1" />
    <xacro:reem_caster_simple_transmission name="caster" side="${side}" number="2" reduction="1" />
  </xacro:macro>

  <!-- simplified box collision geometry for sick laser -->
  <property name="base_laser_x" value="0.08" />
  <property name="base_laser_y" value="0.0" />
  <property name="base_laser_z" value="0.08" />
  <property name="base_laser_size_x" value="0.11" />
  <property name="base_laser_size_y" value="0.11" />
  <property name="base_laser_size_z" value="0.16" />
  <property name="base_laser_collision_offset_z" value="0.00" />
  <property name="base_laser_collision_offset_y" value="0.00" />
  <property name="base_laser_collision_offset_x" value="0.00" />


  <!-- simplified box collision geometry for hokuyo laser -->
  <property name="torso_laser_x" value="0.04" />
  <property name="torso_laser_y" value="0.0" />
  <property name="torso_laser_z" value="0.77" />
  <!--property name="torso_laser_size_x" value="0.05" />
  <property name="torso_laser_size_y" value="0.05" />
  <property name="torso_laser_size_z" value="0.03" /-->
  <!--property name="torso_laser_collision_offset_z" value="0.750" /-->

  <xacro:macro name="reem_base" params="name">

    <!--************************-->
    <!--        BASE            -->
    <!--************************-->

    <link name="${name}_link">
      <inertial>
        <origin xyz="-0.14527 -0.00003 0.24721" rpy="0 0 0" /> <!-- assuming d=0.6, w=0.5, h=0.4 -->
        <mass value="63.58850" />
        <inertia ixx="3.42"  ixy="0"  ixz="0" iyy="4.33" iyz="0" izz="5.08" /> <!-- assuming d=0.6, w=0.5, h=0.4 -->
      </inertial>
      <visual>
        <origin xyz="0 0 0" rpy="0 0 0" />
        <geometry>
          <mesh filename="package://reem_description/meshes/base/base_low.stl" />
        </geometry>
        <material name="LightGrey" />
      </visual>
      <collision>
        <origin xyz="0 0 0" rpy="0 0 0" />
        <geometry>
          <mesh filename="package://reem_description/meshes/base/convex/base_low_convex.stlb" />
        </geometry>
        <material name="LightGrey" />
      </collision>
    </link>

    <!-- base_footprint fictitious link(frame). It coincides with base_link in our case. Provided for convenience when
    using the navigation stack -->
    <link name="${name}_footprint">
      <inertial>
        <mass value="1.0" />
        <origin xyz="0 0 0" />
        <inertia ixx="0.01" ixy="0.0" ixz="0.0"
                 iyy="0.01" iyz="0.0" izz="0.01" />
      </inertial>
      <visual>
        <origin xyz="0 0 0" rpy="0 0 0" />
        <geometry>
          <box size="0.01 0.01 0.01" />
        </geometry>

        <material name="White" />
      </visual>
      <collision>
        <origin xyz="0 0 0.2" rpy="0 0 0" />
        <geometry>
          <box size="0.001 0.001 0.001" />
        </geometry>
      </collision>
    </link>

    <joint name="${name}_footprint_joint" type="fixed">
      <origin xyz="0 0 0" rpy="0 0 0" />
      <child link="${name}_link" />
      <parent link="${name}_footprint"/>
    </joint>


   <!-- base laser -->
    <xacro:sick_laser_reem name="${name}_laser" parent="${name}" ros_topic="LAS_00" update_rate="50" min_angle="-60" max_angle="60" >
      <origin xyz="${base_laser_x} ${base_laser_y} ${base_laser_z}" rpy="${180.0 * deg_to_rad} 0 0" />
    </xacro:sick_laser_reem>

    <!-- torso laser -->
    <xacro:hokuyo_laser_reem name="${name}_torso_laser" parent="${name}" ros_topic="LAS_01" update_rate="10" min_angle="-135" max_angle="135" >
      <origin xyz="${torso_laser_x} ${torso_laser_y} ${torso_laser_z}" rpy="-0.07 ${65 * deg_to_rad} 0 " />
    </xacro:hokuyo_laser_reem>

    <!-- base ir -->
    <xacro:range_reem name="${name}_ir_00" parent="${name}" ros_topic="SonarBaseRing" update_rate="5" maxRange="0.83" minRange="0.005" fov="0.3491">
      <origin xyz="0.17131 0.0 0.1425" rpy="0.0 0.0 0.0" />
    </xacro:range_reem>

    <!-- base ir -->
    <xacro:range_reem name="${name}_ir_01" parent="${name}" ros_topic="SonarBaseRing" update_rate="5" maxRange="0.83" minRange="0.005" fov="0.3491">
      <origin xyz="0.16919 0.12345 0.1425" rpy="0.0 0.0 0.349" />
    </xacro:range_reem>

   <!-- base sonar 2 -->
    <xacro:range_reem name="${name}_ir_02" parent="${name}" ros_topic="SonarBaseRing" update_rate="5" maxRange="0.83" minRange="0.0" fov="0.3491" >
      <origin xyz="0.16919 -0.12345 0.1425" rpy="0.0 0.0 -0.349" />
    </xacro:range_reem>
 
   <!-- base sonar 3 -->
    <xacro:range_reem name="${name}_ir_03" parent="${name}" ros_topic="SonarBaseRing" update_rate="5" maxRange="0.80" minRange="0.0" fov="0.3491" >
      <origin xyz="0.13676 0.27111 0.13702" rpy="0.0 0.0 0.8377" /> <!--3 y 4  x=0.11676 y=0.25111-->
    </xacro:range_reem>
 
   <!-- base sonar 4 -->
    <xacro:range_reem name="${name}_ir_04" parent="${name}" ros_topic="SonarBaseRing" update_rate="5" maxRange="0.80" minRange="0.0" fov="0.3491" >
      <origin xyz="0.13676 -0.27111 0.13702" rpy="0.0 0.0 -0.8377" />
    </xacro:range_reem>

   <!-- base sonar 5 -->
    <xacro:range_reem name="${name}_ir_05" parent="${name}" ros_topic="SonarBaseRing" update_rate="5" maxRange="0.85" minRange="0.0" fov="0.3491" >
      <origin xyz="0.064 0.31455 0.1475" rpy="0.0 0.0 1.5708" /> <!--5 y 6  y=0.29455 -->
    </xacro:range_reem>

   <!-- base sonar 6 -->
    <xacro:range_reem name="${name}_ir_06" parent="${name}" ros_topic="SonarBaseRing" update_rate="5" maxRange="0.85" minRange="0.0" fov="0.3491" >
      <origin xyz="0.064 -0.31455 0.1475" rpy="0.0 0.0 -1.5708" />
    </xacro:range_reem>

   <!-- base sonar 7 -->
    <xacro:range_reem name="${name}_ir_07" parent="${name}" ros_topic="SonarBaseRing" update_rate="5" maxRange="0.62" minRange="0.0" fov="0.3491" >
      <origin xyz="-0.35563 0.28266 0.11219" rpy="0.0 0.0 1.9547" /> <!--7 y 8  y=0.27266 -->
    </xacro:range_reem>

   <!-- base sonar 8 -->
    <xacro:range_reem name="${name}_ir_08" parent="${name}" ros_topic="SonarBaseRing" update_rate="5" maxRange="0.62" minRange="0.0" fov="0.3491" >
      <origin xyz="-0.35563 -0.28266 0.11219" rpy="0.0 0.0 -1.9547" />
    </xacro:range_reem>

   <!-- base sonar 9 -->
    <xacro:range_reem name="${name}_ir_09" parent="${name}" ros_topic="SonarBaseRing" update_rate="5" maxRange="0.87" minRange="0.0" fov="0.3491" >
      <origin xyz="-0.49412 0.15127 0.15748" rpy="0.0 0.0 2.6354" /> <!--10 y 9  x=0.45412 -->
    </xacro:range_reem>

   <!-- base sonar 10 -->
    <xacro:range_reem name="${name}_ir_10" parent="${name}" ros_topic="SonarBaseRing" update_rate="5" maxRange="0.87" minRange="0.0" fov="0.3491" >
      <origin xyz="-0.49412 -0.15127 0.15748" rpy="0.0 0.0 -2.6354" /> 
    </xacro:range_reem>

   <!-- base sonar 11 -->
    <xacro:range_reem name="${name}_ir_11" parent="${name}" ros_topic="SonarBaseRing" update_rate="5" maxRange="0.68" minRange="0.0" fov="0.3491" >
      <origin xyz="-0.52188 0.0 0.12547" rpy="0.0 0.0 -3.1415" />  <!--11  x=-0.50188 -->
    </xacro:range_reem>

 <!-- Torso Front Sonar Ring -->
   <!-- torso sonar 0 -->
   <xacro:range_reem name="${name}_ir_t_0" parent="${name}" ros_topic="SonarUpperBody" update_rate="10" maxRange="0.45" minRange="0.0" fov="0.3491" >
      <origin xyz="0.04 0.065 0.95" rpy="0.0 0.0 0.0" />
   </xacro:range_reem> 

   <!-- torso sonar 1 -->
   <xacro:range_reem name="${name}_ir_t_1" parent="${name}" ros_topic="SonarUpperBody" update_rate="10" maxRange="0.45" minRange="0.0" fov="0.3491" >
      <origin xyz="0.04 -0.065 0.95" rpy="0.0 0.0 0.0" />
   </xacro:range_reem>  
  
 <!-- Head Sonar -->
   <xacro:range_reem name="${name}_ir_h_0" parent="${name}" ros_topic="SonarUpperBody" update_rate="10" maxRange="0.5" minRange="0.0" fov="0.3491" >
      <origin xyz="0.035 0.0 1.55" rpy="0.0 0.0 0.0" />
   </xacro:range_reem> 


    <!-- gyroscope microinfinity XA3300
    <xacro:microinfinity_xa3300 name="imu" parent="${name}" imu_topic="imu/data" update_rate="100.0" stdev="0.0005" >
        <origin xyz="-0.35231 0.0 0.0040" rpy=" ${180.0 * deg_to_rad} 0 0" />
    </xacro:microinfinity_xa3300> -->

    <!-- imu -->
    <xacro:microstrain_3dmgx2_imu_v0 name="imu" parent="${name}" imu_topic="imu/data" update_rate="100.0" stdev="0.00017" >
    <origin xyz="-0.02977 -0.1497 0.164" rpy="0 ${M_PI} 0" />
    </xacro:microstrain_3dmgx2_imu_v0>

    <!-- wheels -->
    <xacro:reem_wheel side="right" reflect="1.0" />
    <xacro:reem_wheel side="left" reflect="-1.0" />

    <!-- casters -->
    <xacro:reem_caster side="right" reflect=" 1.0" />
    <xacro:reem_caster side="left"  reflect="-1.0" />

    <!-- extensions -->
    <xacro:reem_base_gazebo />
    <xacro:reem_base_controllers />

  </xacro:macro>


  <xacro:macro name="reem_cargo" params="name">

    <!--************************-->
    <!--        CARGO           -->
    <!--************************-->

    <link name="${name}_cargo_link">
      <inertial>
        <mass value="1.0" />
        <origin xyz="0 0 0" />
        <inertia ixx="0.01" ixy="0.0" ixz="0.0"
                 iyy="0.01" iyz="0.0" izz="0.01" />
      </inertial>
      <visual>
        <origin xyz="0 0 -0.5" rpy="0 0 0" />
        <geometry>
          <box size="0.001 0.001 0.001" />
        </geometry>

        <material name="Green" />
      </visual>
      <collision>
        <origin xyz="0 0 0.0" rpy="0 0 0" />
        <geometry>
          <box size="0.45 0.45 0.25" /> <!-- Generous hand luggage size allowed in an airplane is 0.55x0.45x0.25. This slightly smaller. -->
        </geometry>
      </collision>
    </link>

    <joint name="${name}_cargo_link" type="fixed">
      <origin xyz="-0.41 0 0.605" rpy="0 0.18 0" />
      <child link="${name}_cargo_link" />
      <parent link="${name}_link"/>
    </joint>

  </xacro:macro>
</robot>
